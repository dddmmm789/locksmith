<!DOCTYPE html>
<html>
<head>
    <title>Track Your Locksmith</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://maps.googleapis.com/maps/api/js?key={{ config.GOOGLE_MAPS_API_KEY }}&libraries=geometry"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }

        .professional-header {
            background: white;
            border-radius: 16px;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .profile-photo {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            object-fit: cover;
        }

        .professional-info h2 {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .rating {
            color: #ffc107;
            margin-bottom: 4px;
        }

        .eta-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .status-message h3 {
            font-size: 16px;
            color: #666;
            margin-bottom: 8px;
        }

        .destination {
            font-size: 18px;
            font-weight: 500;
            color: #333;
        }

        .eta-time {
            font-size: 36px;
            font-weight: 700;
            color: #00a082;
            margin: 16px 0 8px;
        }

        .trip-details {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .contact-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .contact-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 16px;
            border-radius: 12px;
            text-decoration: none;
            color: white;
            font-weight: 500;
            transition: opacity 0.2s;
        }

        .contact-btn:hover {
            opacity: 0.9;
        }

        .contact-btn.call { background: #00a082; }
        .contact-btn.text { background: #0088cc; }
        .contact-btn.whatsapp { background: #25d366; }

        .address-section {
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .address-btn {
            width: 100%;
            padding: 16px;
            margin-bottom: 12px;
            border: 1px dashed #00a082;
            border-radius: 8px;
            background: none;
            color: #00a082;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .address-btn:hover {
            background: #e8f5e9;
        }

        .map-container {
            height: 300px;
            width: 100%;
            margin-bottom: 20px;
            border-radius: 16px;
            overflow: hidden;
            background: #f0f0f0;  /* Visual indicator */
            border: 1px solid #ddd;  /* Visual indicator */
            position: relative;  /* Ensure proper stacking */
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .locksmith-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .locksmith-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .locksmith-photo {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 16px;
        }

        .locksmith-info h2 {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .rating {
            color: #ffc107;
            margin-bottom: 4px;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            background: #e8f5e9;
            color: #00a082;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .contact-button {
            display: block;
            background: #00a082;
            color: white;
            text-decoration: none;
            padding: 16px;
            border-radius: 12px;
            text-align: center;
            font-weight: 500;
            margin-top: 16px;
        }

        .address-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .address-card h3 {
            font-size: 16px;
            color: #666;
            margin-bottom: 8px;
        }

        .address-card p {
            font-size: 18px;
            margin-bottom: 16px;
        }

        .address-details {
            display: flex;
            justify-content: space-between;
            margin-top: 16px;
        }

        .btn-details {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-verify {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-verify.correct {
            background: #e8f5e9;
            color: #00a082;
        }

        .btn-verify.incorrect {
            background: #ffc107;
            color: white;
        }

        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal-content {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            z-index: 1001;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }

        .modal-content textarea {
            width: 100%;
            height: 120px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 16px 0;
            font-family: inherit;
            resize: vertical;
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .modal-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
        }

        .modal-btn.cancel {
            background: #f1f3f5;
            color: #666;
        }

        .modal-btn.save {
            background: #00a082;
            color: white;
        }

        .details-text {
            margin-top: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 14px;
            color: #666;
            width: 100%;
        }

        .address-details {
            margin-bottom: 16px;
        }

        .btn-details {
            width: 100%;
            background: #f8f9fa;
            color: #00a082;
            border: 1px dashed #00a082;
            transition: all 0.2s;
        }

        .btn-details:hover {
            background: #e8f5e9;
        }

        .address-verification {
            display: flex;
            gap: 12px;
        }

        .btn-verify {
            flex: 1;
            padding: 16px;
            text-align: center;
            transition: all 0.2s;
        }

        .btn-verify.correct:hover {
            background: #c8e6c9;
        }

        .btn-verify.incorrect:hover {
            background: #ffb300;
        }

        .debug-section {
            margin-top: 20px;
            text-align: right;
        }

        .btn-debug {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            background: #00a082;
            color: white;
        }

        .eta-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .destination-info h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .address-display {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            color: #333;
        }

        .edit-address-btn {
            background: none;
            border: none;
            padding: 4px;
            cursor: pointer;
            color: #00a082;
        }

        .pencil-icon {
            font-size: 14px;
        }

        .route-info {
            text-align: right;
            color: #666;
            font-size: 14px;
        }

        .progress-section {
            position: relative;
        }

        .progress-bar {
            height: 4px;
            background: #e9ecef;
            border-radius: 2px;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: #00a082;
            border-radius: 2px;
            width: 66%; /* 2nd step of 3 */
            transition: width 0.3s ease;
        }

        .rating-link {
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            color: inherit;
        }

        .rating {
            color: #ffc107;
        }

        .reviews-count {
            color: #666;
            font-size: 14px;
            text-decoration: underline;
        }

        .rating-link:hover .reviews-count {
            color: #00a082;
        }

        .completion-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: #f5f5f5;
        }

        .completion-card {
            background: white;
            border-radius: 24px;
            padding: 40px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            max-width: 400px;
            width: 100%;
        }

        .completion-icon {
            width: 80px;
            height: 80px;
            background: #e8f5e9;
            color: #00a082;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin: 0 auto 24px;
        }

        .completion-card h1 {
            font-size: 24px;
            color: #333;
            margin-bottom: 12px;
        }

        .thank-you {
            color: #666;
            margin-bottom: 32px;
        }

        .locksmith-profile {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 16px;
            margin-bottom: 32px;
        }

        .locksmith-profile .profile-photo {
            width: 60px;
            height: 60px;
        }

        .locksmith-info h2 {
            font-size: 18px;
            margin-bottom: 4px;
        }

        .review-button {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: #00a082;
            color: white;
            text-decoration: none;
            padding: 16px 32px;
            border-radius: 24px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .review-button:hover {
            background: #008c70;
            transform: translateY(-1px);
        }

        .arrow {
            font-size: 20px;
        }

        .review-section {
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .review-container {
            max-width: 500px;
            margin: 0 auto;
        }

        .star-rating {
            display: flex;
            flex-direction: row-reverse;
            gap: 4px;
            margin-bottom: 16px;
        }

        .star-rating input {
            display: none;
        }

        .star-rating label {
            font-size: 24px;
            color: #ddd;
            cursor: pointer;
        }

        .star-rating input:checked ~ label,
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #ffc107;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        {% if job.status == 'completed' %}
        <div class="completion-screen">
            <div class="completion-card">
                <div class="completion-icon">✓</div>
                <h1>Service Completed</h1>
                <p class="thank-you">Thank you for choosing {{ job.locksmith.name }}</p>
                <div class="locksmith-profile">
                    <img src="{{ url_for('static', filename='uploads/' + job.locksmith.profile_photo) }}" 
                         alt="{{ job.locksmith.name }}" 
                         class="profile-photo">
                    <div class="locksmith-info">
                        <h2>{{ job.locksmith.name }}</h2>
                        <div class="rating">★★★★★</div>
                    </div>
                </div>
                <a href="{{ url_for('locksmith.reviews', locksmith_id=job.locksmith.id) }}#write-review" 
                   class="review-button">
                    Write a Review
                    <span class="arrow">→</span>
                </a>
            </div>
        </div>
        {% else %}
        <!-- Professional Header -->
        <div class="professional-header">
            <img src="{{ url_for('static', filename='uploads/' + job.locksmith.profile_photo) }}" 
                 alt="{{ job.locksmith.name }}" 
                 class="profile-photo">
            <div class="professional-info">
                <h2>{{ job.locksmith.name }}</h2>
                <a href="{{ url_for('locksmith.reviews', locksmith_id=job.locksmith.id, tracking_id=job.tracking_id) }}" class="rating-link">
                    <div class="rating">★★★★★</div>
                    <span class="reviews-count">View {{ total_reviews }} reviews</span>
                </a>
                <p>Professional locksmith with over 5 years of experience</p>
            </div>
        </div>

        <!-- ETA Card -->
        <div class="eta-card">
            <div class="status-message">
                <h3>{{ job.locksmith.name }} is on the way to</h3>
                <p class="destination">{{ job.customer_address }}</p>
            </div>
            <div class="eta-info">
                <div class="eta-time" id="eta">Calculating arrival time...</div>
                <div class="trip-details">
                    <span id="distance">Calculating distance...</span> • 
                    <span id="duration">Calculating duration...</span>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill"></div>
            </div>
            <div class="status-steps">
                <div class="step completed">
                    <div class="step-icon">✓</div>
                    <span>Order received</span>
                </div>
                <div class="step active">
                    <div class="step-icon">🚗</div>
                    <span>On the way</span>
                </div>
                <div class="step">
                    <div class="step-icon">🎯</div>
                    <span>Arrived</span>
                </div>
            </div>
        </div>

        <!-- Map -->
        <div class="map-container">
            <div id="map"></div>
        </div>

        <!-- Contact Buttons -->
        <div class="contact-buttons">
            <a href="tel:{{ job.locksmith.phone_number }}" class="contact-btn call">
                <i class="icon">📞</i>
                <span>Call {{ job.locksmith.name }}</span>
            </a>
            <a href="sms:{{ job.locksmith.phone_number }}" class="contact-btn text">
                <i class="icon">✉️</i>
                <span>Send Text</span>
            </a>
            <a href="https://wa.me/{{ job.locksmith.phone_number|replace('+', '') }}" class="contact-btn whatsapp">
                <i class="icon">💬</i>
                <span>WhatsApp</span>
            </a>
        </div>

        <!-- Address Section -->
        <div class="address-section">
            <button onclick="correctAddress()" class="address-btn">
                <i class="icon">✎</i>
                <span>Update Address</span>
            </button>
            <button onclick="addDetails()" class="address-btn">
                <i class="icon">➕</i>
                <span>Add Apartment/Floor Details</span>
            </button>
            <div id="details-text" class="details-text" style="display: none;">
                {{ job.location_details or 'No additional details provided' }}
            </div>
        </div>
        {% endif %}
    </div>

    <script>
        // Add global error handler for Google Maps
        window.gm_authFailure = function() {
            console.error('Google Maps authentication failed');
            window.lastError = 'Google Maps API key authentication failed';
            document.getElementById('map').innerHTML = 
                '<div style="padding: 20px; text-align: center;">Map loading failed. Please try again later.</div>';
        };

        // Add at the start of your script section
        window.appState = {
            userActions: [],
            errors: [],
            lastAddress: null,
            lastDetails: null,
            scriptLoadErrors: []
        };

        // Update error tracking
        window.addEventListener('error', function(event) {
            const error = {
                timestamp: new Date().toISOString(),
                message: event.message,
                source: event.filename,
                line: event.lineno,
                column: event.colno,
                error: event.error?.toString(),
                stack: event.error?.stack
            };
            
            console.error('Error caught:', error);
            window.appState.errors.push(error);
        });

        // Add unhandled promise rejection tracking
        window.addEventListener('unhandledrejection', function(event) {
            const error = {
                timestamp: new Date().toISOString(),
                type: 'promise_rejection',
                message: event.reason?.message || event.reason,
                stack: event.reason?.stack
            };
            
            console.error('Promise rejection:', error);
            window.appState.errors.push(error);
        });

        let map;
        let locksmithMarker;
        let destinationMarker;
        let updateInterval;
        let routeLine;

        // Replace the map styles section with this constant
        const MAP_STYLE = [
          {
            "elementType": "geometry",
            "stylers": [{"color": "#ebe3cd"}]
          },
          {
            "elementType": "labels.text.fill",
            "stylers": [{"color": "#523735"}]
          },
          {
            "elementType": "labels.text.stroke",
            "stylers": [{"color": "#f5f1e6"}]
          },
          {
            "featureType": "administrative",
            "elementType": "geometry.stroke",
            "stylers": [{"color": "#c9b2a6"}]
          },
          {
            "featureType": "administrative.land_parcel",
            "stylers": [{"visibility": "off"}]
          },
          {
            "featureType": "administrative.land_parcel",
            "elementType": "geometry.stroke",
            "stylers": [{"color": "#dcd2be"}]
          },
          {
            "featureType": "administrative.land_parcel",
            "elementType": "labels.text.fill",
            "stylers": [{"color": "#ae9e90"}]
          },
          {
            "featureType": "administrative.neighborhood",
            "stylers": [{"visibility": "off"}]
          },
          {
            "featureType": "landscape.natural",
            "elementType": "geometry",
            "stylers": [{"color": "#dfd2ae"}]
          },
          {
            "featureType": "poi",
            "elementType": "geometry",
            "stylers": [{"color": "#dfd2ae"}]
          },
          {
            "featureType": "poi",
            "elementType": "labels.text",
            "stylers": [{"visibility": "off"}]
          },
          {
            "featureType": "poi",
            "elementType": "labels.text.fill",
            "stylers": [{"color": "#93817c"}]
          },
          {
            "featureType": "poi.business",
            "stylers": [{"visibility": "off"}]
          },
          {
            "featureType": "poi.park",
            "elementType": "geometry.fill",
            "stylers": [{"color": "#a5b076"}]
          },
          {
            "featureType": "poi.park",
            "elementType": "labels.text",
            "stylers": [{"visibility": "off"}]
          },
          {
            "featureType": "poi.park",
            "elementType": "labels.text.fill",
            "stylers": [{"color": "#447530"}]
          },
          {
            "featureType": "road",
            "elementType": "geometry",
            "stylers": [{"color": "#f5f1e6"}]
          },
          {
            "featureType": "road",
            "elementType": "labels",
            "stylers": [{"visibility": "off"}]
          },
          {
            "featureType": "road.arterial",
            "elementType": "geometry",
            "stylers": [{"color": "#fdfcf8"}]
          },
          {
            "featureType": "road.highway",
            "elementType": "geometry",
            "stylers": [{"color": "#f8c967"}]
          },
          {
            "featureType": "road.highway",
            "elementType": "geometry.stroke",
            "stylers": [{"color": "#e9bc62"}]
          },
          {
            "featureType": "road.highway.controlled_access",
            "elementType": "geometry",
            "stylers": [{"color": "#e98d58"}]
          },
          {
            "featureType": "road.highway.controlled_access",
            "elementType": "geometry.stroke",
            "stylers": [{"color": "#db8555"}]
          },
          {
            "featureType": "road.local",
            "elementType": "labels.text.fill",
            "stylers": [{"color": "#806b63"}]
          },
          {
            "featureType": "transit.line",
            "elementType": "geometry",
            "stylers": [{"color": "#dfd2ae"}]
          },
          {
            "featureType": "transit.line",
            "elementType": "labels.text.fill",
            "stylers": [{"color": "#8f7d77"}]
          },
          {
            "featureType": "transit.line",
            "elementType": "labels.text.stroke",
            "stylers": [{"color": "#ebe3cd"}]
          },
          {
            "featureType": "transit.station",
            "elementType": "geometry",
            "stylers": [{"color": "#dfd2ae"}]
          },
          {
            "featureType": "water",
            "elementType": "geometry.fill",
            "stylers": [{"color": "#b9d3c2"}]
          },
          {
            "featureType": "water",
            "elementType": "labels.text",
            "stylers": [{"visibility": "off"}]
          },
          {
            "featureType": "water",
            "elementType": "labels.text.fill",
            "stylers": [{"color": "#92998d"}]
          }
        ];

        function initMap() {
            console.log('initMap called');
            
            // Prevent double initialization
            if (window.mapInitialized) {
                console.log('Map already initialized');
                return;
            }
            
            const mapDiv = document.getElementById('map');
            if (!mapDiv) {
                const error = 'Map container not found';
                console.error(error);
                window.appState.errors.push({
                    timestamp: new Date().toISOString(),
                    type: 'map_init_error',
                    message: error
                });
                return;
            }
            
            try {
                // Initialize map with NYC center
                map = new google.maps.Map(mapDiv, {
                    center: { lat: 40.7128, lng: -74.0060 },
                    zoom: 12,
                    disableDefaultUI: false,
                    zoomControl: true,
                    mapTypeControl: false,
                    scaleControl: true,
                    streetViewControl: false,
                    rotateControl: false,
                    fullscreenControl: true,
                    styles: MAP_STYLE  // Use the constant style
                });
                
                // Mark as initialized
                window.mapInitialized = true;
                
                // Get customer address
                const address = '{{ job.customer_address }}';
                console.log('Geocoding address:', address);
                
                // Geocode address
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ address: address }, function(results, status) {
                    window.geocodeStatus = status;
                    console.log('Geocode status:', status);
                    
                    if (status === 'OK' && results && results[0]) {
                        const destinationPos = results[0].geometry.location;
                        
                        // Update map center
                        map.setCenter(destinationPos);
                        map.setZoom(15);
                        
                        // Create destination marker
                        destinationMarker = new google.maps.Marker({
                            position: destinationPos,
                            map: map,
                            title: 'Destination',
                            icon: {
                                url: "https://maps.google.com/mapfiles/ms/icons/red-dot.png"
                            }
                        });
                        
                        // Create locksmith marker with offset
                        const offset = 0.005; // ~500m offset
                        const locksmithPos = new google.maps.LatLng(
                            destinationPos.lat() - offset,
                            destinationPos.lng() - offset
                        );
                        
                        locksmithMarker = new google.maps.Marker({
                            position: locksmithPos,
                            map: map,
                            title: 'Locksmith',
                            icon: {
                                url: "https://maps.google.com/mapfiles/ms/icons/blue-dot.png"
                            }
                        });
                        
                        // Start location updates
                        updateLocation();
                        updateInterval = setInterval(updateLocation, 10000);
                    } else {
                        console.error('Geocoding failed:', status);
                        window.lastError = `Geocoding failed: ${status}, Address: ${address}`;
                    }
                });
            } catch (error) {
                console.error('Error in initMap:', error);
                window.appState.errors.push({
                    timestamp: new Date().toISOString(),
                    type: 'map_init_error',
                    error: error.toString(),
                    stack: error.stack
                });
            }
        }

        function updateLocation() {
            fetch(`/track/api/location/{{ job.tracking_id }}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Create a custom marker with circular profile photo
                        const markerSize = 40;
                        const canvas = document.createElement('canvas');
                        canvas.width = markerSize;
                        canvas.height = markerSize;
                        const ctx = canvas.getContext('2d');
                        
                        // Create circular clipping path
                        ctx.beginPath();
                        ctx.arc(markerSize/2, markerSize/2, markerSize/2, 0, 2 * Math.PI);
                        ctx.closePath();
                        ctx.clip();

                        // Create image element
                        const img = new Image();
                        img.onload = function() {
                            // Draw circular image
                            ctx.drawImage(img, 0, 0, markerSize, markerSize);
                            
                            // Create marker with the circular image
                            if (locksmithMarker) {
                                locksmithMarker.setIcon({
                                    url: canvas.toDataURL(),
                                    scaledSize: new google.maps.Size(markerSize, markerSize),
                                    anchor: new google.maps.Point(markerSize/2, markerSize/2)
                                });
                                locksmithMarker.setPosition(new google.maps.LatLng(
                                    data.locksmith_location.lat,
                                    data.locksmith_location.lng
                                ));
                            }
                        };
                        img.src = '{{ url_for("static", filename="uploads/" + job.locksmith.profile_photo) }}';

                        // Draw route line
                        const routePath = google.maps.geometry.encoding.decodePath(data.route);
                        if (routeLine) {
                            routeLine.setMap(null);
                        }
                        
                        routeLine = new google.maps.Polyline({
                            path: routePath,
                            geodesic: true,
                            strokeColor: '#2ecc71',
                            strokeOpacity: 1.0,
                            strokeWeight: 4,
                            map: map
                        });

                        // Update info
                        document.getElementById('eta').textContent = data.eta;
                        document.getElementById('distance').textContent = data.distance;
                        document.getElementById('duration').textContent = data.duration;
                    }
                });
        }

        // Cleanup when page is closed
        window.addEventListener('beforeunload', () => {
            if (updateInterval) {
                clearInterval(updateInterval);
            }
        });

        function addDetails() {
            const modalHTML = `
                <div id="details-modal">
                    <div class="modal-backdrop"></div>
                    <div class="modal-content">
                        <h3>Additional Location Details</h3>
                        <textarea id="details-input" placeholder="Enter apartment number, floor, or any specific directions"></textarea>
                        <div class="modal-actions">
                            <button onclick="closeModal()" class="modal-btn cancel">Cancel</button>
                            <button onclick="submitDetails()" class="modal-btn save">Save</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
        }

        function submitDetails() {
            const details = document.getElementById('details-input').value.trim();
            if (!details) return;

            fetch('/track/api/update-details', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    tracking_id: '{{ job.tracking_id }}',
                    details: details
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('details-text').textContent = details;
                    document.getElementById('details-text').style.display = 'block';
                    closeModal();
                } else {
                    throw new Error(data.error || 'Failed to save details');
                }
            })
            .catch(error => alert('Failed to save details: ' + error.message));
        }

        function closeModal() {
            const modal = document.getElementById('details-modal');
            if (modal) modal.remove();
        }

        function confirmAddress() {
            const addressCard = document.querySelector('.address-verification');
            addressCard.innerHTML = `
                <div class="status-badge" style="background: #e8f5e9; color: #00a082; width: 100%; text-align: center;">
                    ✓ Address confirmed
                </div>
            `;
        }

        function correctAddress() {
            const newAddress = prompt('Please enter the correct address:');
            if (!newAddress?.trim()) return;

            fetch('/track/api/update-address', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    tracking_id: '{{ job.tracking_id }}',
                    address: newAddress.trim()
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    throw new Error(data.error || 'Failed to update address');
                }
            })
            .catch(error => alert('Error updating address: ' + error.message));
        }

        function copyDebugLog() {
            const debugInfo = {
                timestamp: new Date().toISOString(),
                page_url: window.location.href,
                job_info: {
                    tracking_id: '{{ job.tracking_id }}',
                    customer_address: '{{ job.customer_address }}',
                    location_details: document.getElementById('details-text')?.textContent || 'No details',
                    status: '{{ job.status }}'
                },
                map_status: {
                    map_initialized: map ? 'Yes' : 'No',
                    locksmith_marker: locksmithMarker ? 'Created' : 'Not created',
                    destination_marker: destinationMarker ? 'Created' : 'Not created',
                    maps_api_loaded: typeof google !== 'undefined' && typeof google.maps !== 'undefined',
                    maps_api_key_present: '{{ config.GOOGLE_MAPS_API_KEY }}' !== '',
                    geocoder_status: window.geocodeStatus || 'Not attempted',
                    script_load_errors: window.appState.scriptLoadErrors
                },
                user_actions: window.appState.userActions,
                last_attempted_address: window.appState.lastAddress,
                last_attempted_details: window.appState.lastDetails,
                errors: window.appState.errors,
                eta_info: {
                    current_eta: document.getElementById('eta')?.textContent || 'Not available'
                },
                browser_info: {
                    user_agent: navigator.userAgent,
                    screen_size: `${window.innerWidth}x${window.innerHeight}`,
                    platform: navigator.platform
                },
                errors: window.lastError || 'No errors recorded'
            };

            // Format the debug info nicely
            const debugText = JSON.stringify(debugInfo, null, 2);
            
            // Log to console for reference
            console.log('Debug Info:', debugInfo);
            
            // Copy to clipboard
            navigator.clipboard.writeText(debugText)
                .then(() => {
                    alert('Debug information copied to clipboard!');
                })
                .catch(err => {
                    console.error('Failed to copy:', err);
                    // Fallback method
                    const textarea = document.createElement('textarea');
                    textarea.value = debugText;
                    document.body.appendChild(textarea);
                    textarea.select();
                    try {
                        document.execCommand('copy');
                        alert('Debug information copied to clipboard!');
                    } catch (e) {
                        alert('Failed to copy debug information. Check browser console.');
                    }
                    document.body.removeChild(textarea);
                });
        }

        // Add error tracking
        window.addEventListener('error', function(event) {
            window.lastError = {
                message: event.message,
                source: event.filename,
                line: event.lineno,
                column: event.colno,
                error: event.error?.toString()
            };
        });

        // Handle Google Maps script load error
        document.querySelector('script[src*="maps.googleapis.com"]').onerror = function() {
            console.error('Failed to load Google Maps script');
            window.appState.scriptLoadErrors.push({
                timestamp: new Date().toISOString(),
                error: 'Failed to load Google Maps script'
            });
            document.getElementById('map').innerHTML = 
                '<div style="padding: 20px; text-align: center;">Map loading failed. Please try again later.</div>';
        };

        // Initialize map when page loads
        window.addEventListener('load', initMap);

        {% if job.status == 'active' %}
        function checkJobStatus() {
            fetch(`/track/api/location/{{ job.tracking_id }}`)
                .then(response => response.json())
                .then(data => {
                    if (data.job_completed) {
                        location.reload();
                    }
                });
        }

        // Check job status every 10 seconds
        setInterval(checkJobStatus, 10000);
        {% endif %}

        // Auto-refresh the page every 2 minutes
        const REFRESH_INTERVAL = 2 * 60 * 1000; // 2 minutes in milliseconds

        function refreshPage() {
            // Only refresh if the page is visible
            if (!document.hidden) {
                location.reload();
            }
        }

        // Set up auto-refresh
        setInterval(refreshPage, REFRESH_INTERVAL);

        // Also refresh when the page becomes visible again
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                location.reload();
            }
        });
    </script>

    {% if job.status == 'completed' %}
    <div id="reviewForm" class="review-section" style="display: none;">
        <div class="review-container">
            <h2>Write a Review for {{ job.locksmith.name }}</h2>
            <form onsubmit="submitReview(event)">
                <div class="form-group">
                    <label>Rating *</label>
                    <div class="star-rating">
                        <input type="radio" id="star5" name="rating" value="5" required>
                        <label for="star5">★</label>
                        <input type="radio" id="star4" name="rating" value="4">
                        <label for="star4">★</label>
                        <input type="radio" id="star3" name="rating" value="3">
                        <label for="star3">★</label>
                        <input type="radio" id="star2" name="rating" value="2">
                        <label for="star2">★</label>
                        <input type="radio" id="star1" name="rating" value="1">
                        <label for="star1">★</label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Your Name (optional)</label>
                    <input type="text" name="reviewer_name">
                </div>
                
                <div class="form-group">
                    <label>Your Review *</label>
                    <textarea name="comment" rows="4" required></textarea>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Submit Review</button>
                </div>
            </form>
        </div>
    </div>

    <script>
    function submitReview(event) {
        event.preventDefault();
        const form = event.target;
        
        const data = {
            rating: parseInt(form.rating.value),
            reviewer_name: form.reviewer_name.value.trim(),
            comment: form.comment.value.trim()
        };

        fetch(`/locksmith/reviews/{{ job.locksmith_id }}/submit`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Thank you for your review!');
                window.location.href = `/locksmith/reviews/{{ job.locksmith_id }}`;
            } else {
                throw new Error(data.error || 'Failed to submit review');
            }
        })
        .catch(error => {
            alert('Error submitting review: ' + error.message);
        });
    }

    // Show review form if hash is #write-review
    if (window.location.hash === '#write-review') {
        document.getElementById('reviewForm').style.display = 'block';
    }
    </script>
    {% endif %}
</body>
</html> 