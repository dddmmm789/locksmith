{% extends "base.html" %}

{% block title %}Locksmith Dashboard{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="header">
        <h1>Dashboard</h1>
        <a href="{{ url_for('locksmith.new_job') }}" class="btn-primary">New Job</a>
    </div>

    <!-- Active Jobs Section -->
    <div class="section">
        <h2>Active Jobs</h2>
        <div class="jobs-grid">
            {% if active_jobs %}
                {% for job in active_jobs %}
                <div class="job-card">
                    <div class="job-header">
                        <h3>Job #{{ job.tracking_id[:8] }}</h3>
                        <span class="status-badge">Active</span>
                    </div>
                    <div class="job-details">
                        <p><strong>Customer Phone:</strong> {{ job.customer_phone }}</p>
                        <p><strong>Address:</strong> {{ job.customer_address }}</p>
                        <p><strong>Created:</strong> {{ job.created_at.strftime('%B %d, %Y %I:%M %p') }}</p>
                        
                        <!-- Add tracking link and status -->
                        <div class="tracking-info">
                            <p>
                                <strong>Tracking Link:</strong>
                                <span class="tracking-url">{{ url_for('customer.tracking', tracking_id=job.tracking_id, _external=True)|truncate(30, True, '...') }}</span>
                                <button onclick="copyTrackingLink(this, '{{ url_for('customer.tracking', tracking_id=job.tracking_id, _external=True) }}')" class="btn-icon" title="Copy Full Link">ðŸ“‹</button>
                            </p>
                            <p class="tracking-status">
                                <strong>Link Status:</strong>
                                <span class="{% if job.last_viewed %}viewed{% else %}not-viewed{% endif %}">
                                    {% if job.last_viewed %}
                                        Viewed {{ job.last_viewed.strftime('%I:%M %p') }}
                                    {% else %}
                                        Not viewed yet
                                    {% endif %}
                                </span>
                            </p>
                        </div>

                        <!-- Add map -->
                        <div class="map-container">
                            <div id="map-{{ job.id }}" class="job-map"></div>
                        </div>
                    </div>
                    <div class="job-actions">
                        <button onclick="completeJob('{{ job.tracking_id }}')" class="btn-success">Mark Complete</button>
                        <button onclick="sendTrackingLink('{{ job.tracking_id }}')" class="btn-secondary">Send Link</button>
                        <button onclick="openDirections('{{ job.customer_address }}')" class="btn-primary">Get Directions</button>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="no-jobs">No active jobs</p>
            {% endif %}
        </div>
    </div>

    <!-- Completed Jobs Section -->
    <div class="section">
        <h2>Past Jobs</h2>
        <div class="jobs-grid">
            {% if completed_jobs %}
                {% for job in completed_jobs %}
                <div class="job-card completed">
                    <div class="job-header">
                        <h3>Job #{{ job.tracking_id[:8] }}</h3>
                        <span class="status-badge completed">Completed</span>
                    </div>
                    <div class="job-details">
                        <p><strong>Customer Phone:</strong> {{ job.customer_phone }}</p>
                        <p><strong>Address:</strong> {{ job.customer_address }}</p>
                        <p><strong>Completed:</strong> {{ job.completed_at.strftime('%B %d, %Y %I:%M %p') }}</p>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="no-jobs">No completed jobs</p>
            {% endif %}
        </div>
    </div>

    <!-- Profile Section -->
    <div class="section profile-section">
        <div class="section-header">
            <h2>Your Profile</h2>
            <a href="{{ url_for('locksmith.edit_profile', id=locksmith.id) }}" class="btn-secondary">Edit Profile</a>
        </div>
        <div class="profile-card">
            <div class="profile-header">
                {% if locksmith.profile_photo %}
                <img src="{{ url_for('static', filename='uploads/' + locksmith.profile_photo) }}" 
                     alt="{{ locksmith.name }}" class="profile-photo">
                {% endif %}
                <div class="profile-info">
                    <h2>{{ locksmith.name }}</h2>
                    {% if locksmith.tagline %}
                    <p class="tagline">{{ locksmith.tagline }}</p>
                    {% endif %}
                    <div class="rating-summary">
                        <div class="stars">â˜…â˜…â˜…â˜…â˜…</div>
                        <span class="review-count">({{ total_reviews }} reviews)</span>
                    </div>
                </div>
            </div>
            <div class="profile-details">
                <div class="detail-item">
                    <span class="label">Experience:</span>
                    <span class="value">{{ locksmith.years_experience or 0 }} years</span>
                </div>
                <div class="detail-item">
                    <span class="label">License:</span>
                    <span class="value">{{ locksmith.license_number or 'Not provided' }}</span>
                </div>
                {% if locksmith.service_areas %}
                <div class="detail-item">
                    <span class="label">Service Areas:</span>
                    <div class="area-tags">
                        {% for area in locksmith.service_areas.split(',') %}
                        <span class="area-tag">{{ area }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Reviews Section -->
    <div class="section">
        <div class="section-header">
            <h2>Recent Reviews</h2>
            <a href="{{ url_for('locksmith.reviews', locksmith_id=locksmith.id) }}" class="btn-text">View All Reviews</a>
        </div>
        <div class="reviews-grid">
            {% for review in recent_reviews %}
            <div class="review-card">
                <div class="review-header">
                    <div class="stars">
                        {% for _ in range(review.rating) %}â˜…{% endfor %}
                    </div>
                    <span class="review-date">{{ review.review_date.strftime('%B %d, %Y') }}</span>
                </div>
                {% if review.comment %}
                <p class="review-comment">{{ review.comment }}</p>
                {% endif %}
                <p class="reviewer">- {{ review.reviewer_name or 'Anonymous' }}</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<style>
.dashboard-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
}

.header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid #eee;
}

.section {
    margin-bottom: 40px;
}

.jobs-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.job-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.job-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
}

.job-header h3 {
    margin: 0;
    color: #333;
}

.status-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
    background: #00a082;
    color: white;
}

.status-badge.completed {
    background: #28a745;
}

.job-details {
    margin-bottom: 15px;
}

.job-details p {
    margin: 5px 0;
    color: #666;
}

.job-actions {
    display: flex;
    gap: 10px;
}

.btn-success {
    background: #28a745;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    flex: 1;
}

.btn-success:hover {
    background: #218838;
}

.btn-secondary {
    background: #6c757d;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    flex: 1;
}

.btn-secondary:hover {
    background: #5a6268;
}

.no-jobs {
    text-align: center;
    color: #666;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 12px;
}

.btn-primary {
    background: #00a082;
    color: white;
    padding: 10px 20px;
    border-radius: 6px;
    text-decoration: none;
}

.btn-primary:hover {
    background: #008c70;
}

.tracking-info {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 6px;
    margin: 10px 0;
}

.tracking-url {
    font-family: monospace;
    background: #fff;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    margin-right: 8px;
    display: inline-block;
    max-width: 250px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    vertical-align: middle;
}

.btn-icon {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 16px;
    padding: 4px;
    border-radius: 4px;
}

.btn-icon:hover {
    background: #eee;
}

.tracking-status .viewed {
    color: #28a745;
}

.tracking-status .not-viewed {
    color: #6c757d;
}

.map-container {
    margin-top: 15px;
}

.job-map {
    height: 200px;
    border-radius: 8px;
    overflow: hidden;
}

.profile-card {
    background: white;
    border-radius: 16px;
    padding: 24px;
    margin-bottom: 30px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.profile-header {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 20px;
}

.profile-photo {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    object-fit: cover;
}

.profile-info {
    flex: 1;
}

.tagline {
    color: #666;
    font-style: italic;
    margin: 4px 0;
}

.rating-summary {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 4px;
}

.stars {
    color: #ffc107;
}

.review-count {
    color: #666;
}

.profile-details {
    background: #f8f9fa;
    padding: 16px;
    border-radius: 8px;
}

.detail-item {
    margin-bottom: 12px;
}

.detail-item:last-child {
    margin-bottom: 0;
}

.label {
    font-weight: 500;
    margin-right: 8px;
}

.area-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 4px;
}

.area-tag {
    background: #e9ecef;
    color: #495057;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.btn-text {
    color: #00a082;
    text-decoration: none;
    font-weight: 500;
}

.btn-text:hover {
    text-decoration: underline;
}

.reviews-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 20px;
}

.review-card {
    background: white;
    padding: 16px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.review-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
}

.review-date {
    color: #666;
    font-size: 14px;
}

.review-comment {
    color: #333;
    margin-bottom: 12px;
    line-height: 1.4;
}

.reviewer {
    color: #666;
    font-style: italic;
    margin: 0;
}

.profile-section {
    background: white;
    border-radius: 16px;
    padding: 24px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.map-error {
    padding: 20px;
    text-align: center;
    color: #721c24;
    background: #f8d7da;
    border-radius: 8px;
}

.job-map {
    height: 200px;
    border-radius: 8px;
    overflow: hidden;
    position: relative;
    background: #f8f9fa;
}
</style>

<script src="https://maps.googleapis.com/maps/api/js?key={{ config.GOOGLE_MAPS_API_KEY }}&libraries=geometry"></script>

<script>
function completeJob(trackingId) {
    if (!confirm('Mark this job as complete?')) return;
    
    fetch(`/locksmith/job/${trackingId}/complete`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.error || 'Failed to complete job');
        }
    });
}

function sendTrackingLink(trackingId) {
    fetch(`/locksmith/job/${trackingId}/send-link`, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Tracking link sent successfully!');
        } else {
            alert(data.error || 'Failed to send tracking link');
        }
    });
}

// Initialize maps for each job
function initMaps() {
    {% for job in active_jobs %}
    try {
        const mapOptions = {
            zoom: 15,
            center: { lat: 40.7128, lng: -74.0060 }, // Default to NYC
            disableDefaultUI: true,
            zoomControl: true,
            styles: [
                {
                    featureType: "poi",
                    elementType: "labels",
                    stylers: [{ visibility: "off" }]
                },
                {
                    featureType: "transit",
                    elementType: "labels",
                    stylers: [{ visibility: "off" }]
                }
            ]
        };

        const mapElement = document.getElementById('map-{{ job.id }}');
        if (!mapElement) {
            console.error('Map element not found for job {{ job.id }}');
            return;
        }

        const map = new google.maps.Map(mapElement, mapOptions);
        
        // Geocode address
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ 
            address: '{{ job.customer_address|replace("'", "\\'") }}' 
        }, (results, status) => {
            if (status === 'OK' && results && results[0]) {
                const location = results[0].geometry.location;
                map.setCenter(location);
                
                new google.maps.Marker({
                    map: map,
                    position: location,
                    title: 'Customer Location'
                });

                // Fit map to show marker better
                map.setZoom(15);
            } else {
                console.error('Geocoding failed:', status, 'for address:', '{{ job.customer_address|replace("'", "\\'") }}');
                mapElement.innerHTML = '<div class="map-error">Could not load map for this address</div>';
            }
        });
    } catch (error) {
        console.error('Error initializing map for job {{ job.id }}:', error);
    }
    {% endfor %}
}

// Initialize maps when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    // Check if Google Maps is loaded
    if (typeof google === 'undefined') {
        console.error('Google Maps not loaded');
        return;
    }
    initMaps();
});

function copyTrackingLink(button, fullUrl) {
    navigator.clipboard.writeText(fullUrl).then(() => {
        const originalText = button.textContent;
        button.textContent = 'âœ“';
        setTimeout(() => {
            button.textContent = originalText;
        }, 2000);
    });
}

function openDirections(address) {
    window.open(`https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(address)}`, '_blank');
}

// Load Google Maps
function loadGoogleMaps() {
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key={{ config.GOOGLE_MAPS_API_KEY }}&callback=initMaps`;
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
}

// Load maps when page is ready
document.addEventListener('DOMContentLoaded', loadGoogleMaps);

// Auto-refresh active jobs every 2 minutes
const REFRESH_INTERVAL = 2 * 60 * 1000; // 2 minutes in milliseconds

function refreshActiveJobs() {
    // Only refresh if the page is visible
    if (document.hidden) return;

    fetch(window.location.href)
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const newDoc = parser.parseFromString(html, 'text/html');
            
            // Update only the active jobs section
            const currentJobs = document.querySelector('.jobs-grid');
            const newJobs = newDoc.querySelector('.jobs-grid');
            if (currentJobs && newJobs) {
                currentJobs.innerHTML = newJobs.innerHTML;
                // Reinitialize maps for new job cards
                initMaps();
            }
        })
        .catch(error => console.error('Error refreshing jobs:', error));
}

// Set up auto-refresh
setInterval(refreshActiveJobs, REFRESH_INTERVAL);

// Also refresh when the page becomes visible again
document.addEventListener('visibilitychange', function() {
    if (!document.hidden) {
        refreshActiveJobs();
    }
});
</script>
{% endblock %} 